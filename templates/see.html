{% extends "base.html" %}

{% block content %}
<script src="/static/js/jquerypopupoverlay/jquery.popupoverlay.js"></script>

<div class="container">
  <div class="row">
    <div class="col-md-5 col-sm-12 my-md-4">
      <h2 class="mt-3">{{category.name}}</h2>
    </div>
    <div class="col-md-7 col-sm-12 my-md-4">
      {% include "partials/toolbar.html" with categories=categories category=category tags=tags %}
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    {% for submission in submissions %}
      {% include "partials/submission.html" with category=category submission=submission %}
    {% endfor %}
  </div>
</div>

{% include "partials/player.html" %}

<script>
  $(document).ready(function() {
    $('#player').popup({
      scrolllock: true,
      blur: false,
      color: '#fff',
      opacity: 0.97,
      vertical: 'top',
      onclose: function() {
        resetPlayer();
      }
    });
  });

  $('a.player_open').click(function(e) {
    // The field name is case insensitive in Postgres!
    var categoryId = $(this).data('categoryid');
    var submissionId = $(this).data('submissionid');

    $.ajax({
      url: '/api/media/play/' + categoryId + '/' + submissionId,
      method: 'GET',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      success: function(response) {
        // console.log(response);
        if('error' in response) {
          resetPlayer();
          alert(response.error);
        }
        else {
          setPlayer(response)
        }
      }
    });
  });

  var resetPlayer = function() {
    $('.player-fields').text('-');
  }

  var setPlayer = function(res) {
    res.name ?
      $('#player-name').text(res.name) :
      $('#player-name').text('Unknown User');
    res.yearsInNeighborhoodFrom && res.yearsInNeighborhoodTo ?
      $('#player-yearsInNeighborhood').text(res.yearsInNeighborhoodFrom + '-' + res.yearsInNeighborhoodTo) :
      $('#player-yearsInNeighborhood').text('-');
    res.yearOfBirth ?
      $('#player-yearOfBirth').text(res.yearOfBirth) :
      $('#player-yearOfBirth').text('-');
    res.placeOfBirth ?
      $('#player-placeOfBirth').text(res.placeOfBirth) :
      $('#player-placeOfBirth').text('-');
    res.occupations ?
      $('#player-occupations').text(res.occupations) :
      $('#player-occupations').text('-');
    res.description ?
      $('#player-description').text(res.description) :
      $('#player-description').text('-');
    res.tags.length > 0 ?
      $('#player-tags').html(getTagsFormatted(res.tags)) :
      $('#player-tags').text('-');
    res.submissionDate ?
      $('#player-submissionDate').text(res.submissionDate) :
      $('#player-submissionDate').text('-');
    res.mediaType && (res.mediaHash || (res.mediaType && res.blobContent)) ?
      $('#player-content-frame').html(getMediaEmbed(res.mediaType, res.mediaHash, res.blobContent)) : null;
  }

  var getTagsFormatted = function(tags) {
    var res = '';
    for(i in tags) {
      var tag = tags[i];
      res += '<span class="badge badge-primary">' + tag + '</span> &nbsp;';
    }
    return res;
  };

  var getMediaEmbed = function(mediaType, mediaHash, blobContent) {
    if(mediaType == 'youtube') {
      return '<iframe width="100%" height="62%" src="https://www.youtube.com/embed/' + mediaHash + '" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
    }
    else if(mediaType == 'soundcloud') {
      return '<iframe width="100%" height="100%" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/' + mediaHash + '&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>';
    }
    else if(mediaType == 'image') {
      return '<img src="data:image/jpeg;base64,' + blobContent + '" width="100%" />';
    }
    else {
      alert('media type error!');
      return;
    }
  };

  // Media Type Filter
  $('a.media-type-filter').click(function(e) {
    var mediaType = $(this).data('media-type');
    if(mediaType == 'all') {
      $('.submission-wrapper').removeClass('d-none');
      return;
    }
    $('.submission-wrapper').addClass('d-none');
    $.ajax({
      url: '/api/media/filter/type/' + '{{category.slug}}' + '/' + mediaType,
      method: 'GET',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      success: function(response) {
        // console.log(response);
        if('error' in response) {
          //
        }
        else {
          showOnlyRelevent(response);
        }
      }
    });
  });

  // Tag Filter
  $('a.tag-filter').click(function(e) {
    var tag = $(this).data('tag');
    if(tag == 'all') {
      $('.submission-wrapper').removeClass('d-none');
      return;
    }
    $('.submission-wrapper').addClass('d-none');
    $.ajax({
      url: '/api/media/filter/tag/' + '{{category.slug}}' + '/' + tag,
      method: 'GET',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      success: function(response) {
        // console.log(response);
        if('error' in response) {
          //
        }
        else {
          showOnlyRelevent(response);
        }
      }
    });
  });

  $('#search-button').click(function(e) {
    var keyword = $('#search-input').val().trim();
    if(keyword == "") {
      $('.submission-wrapper').removeClass('d-none');
      return;
    }
    $('.submission-wrapper').addClass('d-none');
    $.ajax({
      url: '/api/media/search/' + '{{category.slug}}' + '/' + keyword,
      method: 'GET',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      success: function(response) {
        // console.log(response);
        if('error' in response) {
          //
        }
        else {
          showOnlyRelevent(response);
        }
      }
    });
  });

  var showOnlyRelevent = function(res) {
    for(i in res.submissionIds) {
      var submissionId = res.submissionIds[i];
      $('.submission-wrapper[data-submissionId=' + submissionId + ']').removeClass('d-none');
    }
  };

  $('#search-input').keydown(function(e) {
    if(e.keyCode==13) {
      $('#search-button').click();
    }
  });
</script>

{% endblock content %}
